<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"mengdd.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Android Weekly Issue #224September 25th, 2016Android Weekly Issue #224 本期内容包括: Google Play的pre-launch报告; Wear的Complications API; Android Handler解析; RxAndroid; 测量性能的库: Pury; 方法数限制; APK内容分析; Redux for A">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Weekly Notes Issue 224">
<meta property="og:url" content="http://mengdd.github.io/Android/Android-Weekly/2016/10/02/android-weekly-notes-issue-224/index.html">
<meta property="og:site_name" content="Meng&#39;s pages">
<meta property="og:description" content="Android Weekly Issue #224September 25th, 2016Android Weekly Issue #224 本期内容包括: Google Play的pre-launch报告; Wear的Complications API; Android Handler解析; RxAndroid; 测量性能的库: Pury; 方法数限制; APK内容分析; Redux for A">
<meta property="og:locale">
<meta property="article:published_time" content="2016-10-02T04:17:13.000Z">
<meta property="article:modified_time" content="2022-01-29T16:37:08.991Z">
<meta property="article:author" content="Dandan Meng">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Android Weekly">
<meta property="article:tag" content="Wear">
<meta property="article:tag" content="Memory Leak">
<meta property="article:tag" content="Annotation">
<meta property="article:tag" content="pre-launch">
<meta property="article:tag" content="Handler">
<meta property="article:tag" content="RxAndroid">
<meta property="article:tag" content="Profile">
<meta property="article:tag" content="Methods Count">
<meta property="article:tag" content="APK">
<meta property="article:tag" content="Redux">
<meta property="article:tag" content="Reductor">
<meta property="article:tag" content="Adapter">
<meta property="article:tag" content="Intro Screen">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://mengdd.github.io/Android/Android-Weekly/2016/10/02/android-weekly-notes-issue-224/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>Android Weekly Notes Issue 224 | Meng's pages</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?83e8338b542a9fd155f68673d113e0ae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Meng's pages</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Android developer and maybe other intersting things.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://mengdd.github.io/Android/Android-Weekly/2016/10/02/android-weekly-notes-issue-224/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
      <meta itemprop="name" content="Dandan Meng">
      <meta itemprop="description" content="This is a technical blog site of an Android developer.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Meng's pages">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android Weekly Notes Issue 224
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-10-02 12:17:13" itemprop="dateCreated datePublished" datetime="2016-10-02T12:17:13+08:00">2016-10-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-01-30 00:37:08" itemprop="dateModified" datetime="2022-01-30T00:37:08+08:00">2022-01-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android-Weekly/" itemprop="url" rel="index"><span itemprop="name">Android Weekly</span></a>
                </span>
            </span>

          
            <span id="/Android/Android-Weekly/2016/10/02/android-weekly-notes-issue-224/" class="post-meta-item leancloud_visitors" data-flag-title="Android Weekly Notes Issue 224" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/Android/Android-Weekly/2016/10/02/android-weekly-notes-issue-224/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Android/Android-Weekly/2016/10/02/android-weekly-notes-issue-224/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Android-Weekly-Issue-224"><a href="#Android-Weekly-Issue-224" class="headerlink" title="Android Weekly Issue #224"></a>Android Weekly Issue #224</h1><p>September 25th, 2016<br><a href="http://androidweekly.net/issues/issue-224" target="_blank" rel="noopener">Android Weekly Issue #224</a></p>
<p>本期内容包括: Google Play的pre-launch报告; Wear的Complications API; Android Handler解析; RxAndroid; 测量性能的库: Pury; 方法数限制; APK内容分析; Redux for Android; 一种view造成的泄露; 注解处理; 更好的Adapter; Intro屏等等.</p>
<a id="more"></a>
<h1 id="ARTICLES-amp-TUTORIALS"><a href="#ARTICLES-amp-TUTORIALS" class="headerlink" title="ARTICLES &amp; TUTORIALS"></a>ARTICLES &amp; TUTORIALS</h1><h2 id="Apk的pre-launch报告-Awesome-pre-launch-reports-for-Alpha-Beta-APK’s"><a href="#Apk的pre-launch报告-Awesome-pre-launch-reports-for-Alpha-Beta-APK’s" class="headerlink" title="Apk的pre-launch报告 Awesome pre-launch reports for Alpha/Beta APK’s"></a>Apk的pre-launch报告 <a href="https://medium.com/@AruLNadhaN/awesome-pre-launch-reports-for-alpha-beta-apks-9960ac5c403c#.5qhy3bbqc" target="_blank" rel="noopener">Awesome pre-launch reports for Alpha/Beta APK’s</a></h2><p>Google Play team在I/O 2016的时候宣布了很多新features, 其中有一个pre-launch report.</p>
<p>这个report是干什么的呢, 它会报告在一些设备上测试你的应用的时候发现的issues.</p>
<p>要生成这种报告, 你应该在Developer console上enable它. 然后<a href="https://support.google.com/googleplay/android-developer/answer/3131213" target="_blank" rel="noopener">上传alpha/beta apk</a>. 上传到beta channel之后, 5-10分钟就会生成报告.</p>
<p>报告主要包括三个部分:</p>
<ul>
<li>Crashes</li>
<li>Screenshots</li>
<li>Security</li>
</ul>
<p>官方文档: <a href="https://support.google.com/googleplay/android-developer/answer/7002270#sources" target="_blank" rel="noopener">pre-launch</a></p>
<h2 id="Wear-Complications-API"><a href="#Wear-Complications-API" class="headerlink" title="Wear Complications API"></a><a href="https://medium.com/@danybony_/wear-complications-api-16ab65290aa1#.w6lt2q3rx" target="_blank" rel="noopener">Wear Complications API</a></h2><p>在钟表的定义里, complications是指表上除了小时和分钟指示之外其他的东西.</p>
<p>在Android Wear里面我们已经有一些complications的例子, 比如向用户显示计步器, 天气预报, 下一个会议时间等等.</p>
<p>但是之前有一个很大的限制就是每一个小应用都必须实现自己的逻辑来取数据, 比如有两个应用都取了今天的天气预报信息, 将会有两套机制取同样的数据, 这明显是一种浪费.</p>
<p>Android Wear 2.0推出了Complications API解决了这个问题.</p>
<p>通信主要是<strong>Data providers</strong>和<strong>Watch faces</strong>之间的, 前者包含取数据的逻辑, 后者负责显示.</p>
<p>Complications API定义了一些Complications Types, 见<a href="https://developer.android.com/wear/preview/features/complications.html#using_complication_types" target="_blank" rel="noopener">官方文档</a>.</p>
<p>作者在他朋友的开源应用里用了新的API: <a href="https://github.com/alexstyl/Memento-Namedays" target="_blank" rel="noopener">Memento-Namedays</a>, 这个应用是生日或者日期提醒类的.</p>
<p>首先, 作者用<a href="https://developer.android.com/training/wearables/data-layer/index.html" target="_blank" rel="noopener">Wearable Data Layer API</a>同步了手机和手表的数据. 然后在Wear module里继承<code>ComplicationProviderService</code>创建了complication data provider, 这里就提供了<code>onComplicationActivated</code>, <code>onComplicationDeactivated</code>, <code>onComplicationUpdate</code>等回调. </p>
<p>用户也可以点击Complications, 可以用<code>setTapAction()</code>指定点击后要启动的Activity.</p>
<p>可以指定<code>ComplicationProviderService</code>的更新频率, 是在manifest里用这个key:<br><code>android.support.wearable.complications.UPDATE_PERIOD_SECONDS</code>.</p>
<p>更新得太频繁会比较费电.<br>需要注意的是这并不是一个常量, 因为系统也会根据手机的状况进行一些调节, 不必要的时候就不需要频繁更新.</p>
<p>本文作者采用的方式是用<code>ProviderUpdateRequester</code>. 在manifest里面设置0.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ComponentName providerComponentName = <span class="keyword">new</span> ComponentName(</span><br><span class="line">    context, </span><br><span class="line">    MyComplicationProviderService<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class">)</span>;</span><br><span class="line">ProviderUpdateRequester providerUpdateRequester = <span class="keyword">new</span></span><br><span class="line">    ProviderUpdateRequester(context, providerComponentName);</span><br><span class="line">providerUpdateRequester.requestUpdateAll();</span><br></pre></td></tr></table></figure>
<p>最后, 这里是官网文档:<br><a href="https://developer.android.com/wear/preview/features/complications.html" target="_blank" rel="noopener">Complications</a>.</p>
<p>这里是作者PR: <a href="https://github.com/alexstyl/Memento-Namedays/pull/40" target="_blank" rel="noopener">PR</a></p>
<h2 id="Android-Handler-Internals"><a href="#Android-Handler-Internals" class="headerlink" title="Android Handler Internals"></a><a href="https://medium.com/@jagsaund/android-handler-internals-b5d49eba6977#.xuogmm2c0" target="_blank" rel="noopener">Android Handler Internals</a></h2><p>首先, 作者举了一个简单的例子, 用两种方法, 用Handler来实现下载图片并显示到ImageView上的过程.</p>
<p>主要是因为网络请求需要在非UI线程, 而View操作需要在UI线程. Handler就用来在这两种线程之间切换调度.</p>
<p><strong>Handler的组成</strong></p>
<ul>
<li>Handler</li>
<li>Message</li>
<li>Message Queue</li>
<li>Looper</li>
</ul>
<p><strong>Handler</strong></p>
<p><a href="https://developer.android.com/reference/android/os/Handler.html" target="_blank" rel="noopener">Handler</a>是线程间消息传递的直接接口, 生产者和消费者线程都是通过调用下面的操作和Handler交互:</p>
<ul>
<li>creating, inserting, removing Messages from Message Queue.</li>
<li>processing Messages on the consumer thread.</li>
</ul>
<p>每一个Handler都是和一个Looper和一个Message Queue关联的. 有两种方法来创建一个Handler:</p>
<ul>
<li>用默认构造器, 将会使用当前线程的Looper.</li>
<li>显式地指明要用的Looper.</li>
</ul>
<p>Handler不能没有Looper, 如果构造时没有指明Looper, 当前线程也没有Looper, 那么将会抛出异常.</p>
<p>因为Handler需要Looper中的消息队列.</p>
<p>一个线程上的多个Handler共享同一个消息队列, 因为它们共享同一个Looper.</p>
<p><strong>Message</strong></p>
<p><a href="https://developer.android.com/reference/android/os/Message.html" target="_blank" rel="noopener">Message</a>是一个包含任意数据的容器, 它包含的数据信息是callback, data bundle和obj/arg1/arg2, 还有三个附加数据what, time和target.</p>
<p>可以调用Handler的<code>obtainMessage()</code>方法来创建Message, 这样message是从message pool中取出的, target会自动设置成Handler自己. 所以直接可以在后面调用<code>sendToTarget()</code>方法.</p>
<p>Message pool是一个最大尺寸为50的LinkedList. 当消息被处理完之后, 会放回pool, 并且重置所有字段.</p>
<p>当我们使用Handler来<code>post(Runnable)</code>的时候, 实际上是隐式地创建一个Message, 它的callback存这个Runnable.</p>
<p><strong>Message Queue</strong></p>
<p><a href="https://developer.android.com/reference/android/os/MessageQueue.html" target="_blank" rel="noopener">Message Queue</a> 是一个无边界的LinkedList, 元素是Message对象. 它按照时间顺序来插入Message, 所以timestamp最小的最先分发. </p>
<p>MessageQueue中有一个<code>dispatch barrier</code>表示当前时间, 当message的timestamp小于当前时间时, 被分发和处理.</p>
<p>Handler提供了一些方法在发message的时候设置不同的时间戳:</p>
<p><code>sendMessageDelayed()</code>: 当前时间 + delay时间.</p>
<p><code>sendMessageAtFrontOfQueue()</code>: 把时间戳设为0, 不建议使用.</p>
<p><code>sendMessageAtTime()</code>.</p>
<p>Handler经常需要和UI交互, 可能会引用Activity, 所以也经常会引起内存泄漏.<br>作者举了两个例子, 略.</p>
<p>需要注意:<br>非静态内部类会持有外部类实例引用.<br>Message会持有Handler引用, 主线程的Looper和MessageQueue在程序运行期间是一直存在的.</p>
<p>建议的是, 内部类用static修饰, 另用WeakReference.</p>
<p><strong>Debug Tips</strong><br>显示Looper中dispatched的Messages:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Looper looper = getMainLooper();</span><br><span class="line">looper.setMessageLogging(<span class="keyword">new</span> LogPrinter(Log.DEBUG, <span class="string">"Looper"</span>));</span><br></pre></td></tr></table></figure></p>
<p>显示MessageQueue中和handler相关的pending messages:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handler.dump(<span class="keyword">new</span> LogPrinter(Log.DEBUG, <span class="string">"Handler"</span>), <span class="string">""</span>);</span><br></pre></td></tr></table></figure></p>
<p><strong>Looper</strong></p>
<p><a href="https://developer.android.com/reference/android/os/Looper.html" target="_blank" rel="noopener">Looper</a> 从消息队列中读取消息, 然后分发给target handler. 每当一个Message穿过了<code>dispatch barrier</code>, 它就可以在下一个消息循环中被Looper读.</p>
<p>一个线程只能关联一个Looper. 因为Looper类中有一个静态的ThreadLocal对象保证了只有一个Looper和线程关联, 企图再加一个就会抛出异常.</p>
<p>调用<code>Looper.quit()</code>会立即终止Looper, 丢弃所有消息.<br>而<code>Looper.quitSafely()</code>会将已经通过<code>dispatch barrier</code>的消息处理了, 只丢弃pending的消息.</p>
<p>Looper是在Thread的<code>run()</code>方法里setup的, <code>Looper.prepare()</code>会检查是否之前存在一个<code>Looper</code>和这个线程关联, 如果有则抛异常, 没有则建立一个新的<code>Looper</code>对象, 创建一个新的MessageQueue. 见<a href="https://github.com/android/platform_frameworks_base/blob/e71ecb2c4df15f727f51a0e1b65459f071853e35/core/java/android/os/Looper.java#L83" target="_blank" rel="noopener">代码</a>.</p>
<p>现在<code>Handler</code>可以接收或者发送消息到<code>MessageQueue</code>了. 执行<code>Looper.loop()</code>方法将会开始从队列读出消息. 每一个loop迭代都会取出下一个消息.</p>
<h2 id="Crunching-RxAndroid-Part-10-细细咀嚼RxAndroid"><a href="#Crunching-RxAndroid-Part-10-细细咀嚼RxAndroid" class="headerlink" title="Crunching RxAndroid - Part 10  细细咀嚼RxAndroid"></a><a href="https://medium.com/crunching-rxandroid/crunching-rxandroid-part-10-cc0c33108ee2#.ri2xoc35c" target="_blank" rel="noopener">Crunching RxAndroid - Part 10 </a> 细细咀嚼RxAndroid</h2><p>作者这个是个系列文章, 本文是part 10.</p>
<p>Android的listener很多, 我们可以通过RxJava把listener都变成发射信息的源, 然后我们subscribe.</p>
<p>本文举例讲了<code>Observable.fromCallable()</code>和<code>Observable.fromAsync()</code>方法的用法.</p>
<h2 id="Pury-a-new-way-to-profile-your-Android-application"><a href="#Pury-a-new-way-to-profile-your-Android-application" class="headerlink" title="Pury a new way to profile your Android application"></a><a href="https://medium.com/@nikita.kozlov/pury-new-way-to-profile-your-android-application-7e248b5f615e#.a7a9lsexj" target="_blank" rel="noopener">Pury a new way to profile your Android application</a></h2><p>在做任何优化之前我们都应该先定位问题. 首先是收集性能数据, 如果收集到的信息超过了可以接受的阈值, 我们再进一步深究, 找到引起问题的方法或者API.</p>
<p>幸运的是, 有一些工具可以帮我们profiling:</p>
<ul>
<li><a href="https://github.com/JakeWharton/hugo" target="_blank" rel="noopener">Hugo</a> 用<code>@DebugLog</code>注解来标记方法, 然后参数, 返回值, 执行时间都会log出来.</li>
<li>Android Studio toolset. 比如System Trace, 非常准确, 提供了很多信息, 但是需要你花时间来收集和分析数据.</li>
<li>后台解决方案, 比如<a href="https://jmeter.apache.org/" target="_blank" rel="noopener">JMeter</a>, 它们提供了很多功能, 需要花时间来学习如何使用, 第二就是高并发profile也不是常见的需求.</li>
</ul>
<p><strong>Missing tool</strong></p>
<p>关于我们关心的应用的速度问题, 大多数可以分为两种:</p>
<ul>
<li>特定方法和API的执行时间, 这个可以被Hugo cover.</li>
<li>两个事件之间的时间, 这可能是独立的两段代码, 但是在逻辑上关联. Android Studio toolset可以cover这种, 但是你需要花很多时间来做profile.</li>
</ul>
<p>作者意识到下面的需求没有被满足:</p>
<ul>
<li>开始和结束profiling应该是被两个独立的事件触发的, 这样才可以满足我们灵活性的需求.</li>
<li>如果我们想监控performance, 仅仅开始和结束事件是不够的. 有时候我们需要知道这之间发生了什么, 这些阶段信息应该被放在一个报告里, 让我们更容易明白和分享数据.</li>
<li>有时候我们需要做重复操作, 比如loading RecyclerView的下一页, 那么一个回合的操作显然是不够的, 我们需要进行多次操作, 然后显示统计数据, 比如平均值, 最小最大值.</li>
</ul>
<p>基于上面的需求, 作者创建了Pury.</p>
<p><strong>Introduction to Pury</strong></p>
<p>Pury是一个profiling的库, 用于测量多个独立事件之间的时间.<br>事件可以通过注解或者方法调用来触发, 一个scenario的所有事件被放在同一个报告里.</p>
<p>然后作者举了两个例子, 一个用来测量启动时间, 另一个用来测量loading pages.</p>
<p><strong>Inner structure and limitations</strong></p>
<p>性能测量是<code>Profilers</code>做的, 每一个<code>Profiler</code>包含一个list, 里面是<code>Runs</code>. 多个<code>Profilers</code>可以并行运行, 但是每个<code>Profiler</code>中只有一个<code>Run</code>是active的. </p>
<p><strong>Profiling with Pury</strong></p>
<p>Pury可以测量多个独立事件之间的时间, 事件可以用注解或者方法调用触发.<br>基本的注解有: <code>@StartProfiling</code>, <code>@StopProfiling</code>, <code>@MethodProfiling</code></p>
<p>方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Pury.startProfiling();</span><br><span class="line"></span><br><span class="line">Pury.stopProfiling();</span><br></pre></td></tr></table></figure></p>
<p>最后作者介绍了一些使用细节.<br>项目地址: <a href="https://github.com/NikitaKozlov/Pury" target="_blank" rel="noopener">Pury</a></p>
<h2 id="处理方法数限制问题-Dealing-With-the-65K-Methods-limit-on-Android"><a href="#处理方法数限制问题-Dealing-With-the-65K-Methods-limit-on-Android" class="headerlink" title="处理方法数限制问题 Dealing With the 65K Methods limit on Android"></a>处理方法数限制问题 <a href="http://bytes.schibsted.com/dealing-65k-methods-limit-android/" target="_blank" rel="noopener">Dealing With the 65K Methods limit on Android</a></h2><p>作为Android开发, 你可能会看到过这种信息:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Too many field references: 88974; max is 65536.</span><br><span class="line">You may try using –multi-dex option.</span><br></pre></td></tr></table></figure></p>
<p>首先, 为什么会存在65k的方法数限制呢?</p>
<p>Android应用是放在APK文件里的, 这里面包含了可执行的二进制码文件(DEX - Dalvik Executable), 里面包含了让app工作的代码.</p>
<p>DEX规范限制了单个的DEX文件中的方法总数最大为65535, 包括了Android framework方法, library方法, 还有你自己代码中的方法. 如果超过了这个限制你将不得不配置你的app来生成多个DEX文件(multidex configuration). </p>
<p>但是开启了multidex配置之后有一些随机性的兼容问题, 所以我们在决定开启multidex之前, 首先采取的第一步是减少方法数来避免这个问题.</p>
<p>在我们开始改动之前, 先提出了这些问题:</p>
<ul>
<li>我们有多少方法?</li>
<li>这些方法都是从哪里来?</li>
<li>主要的方法来源是谁?</li>
<li>我们真的需要所有这些方法吗?</li>
</ul>
<p>在搜寻这些问题的答案的过程中, 我们发现了一些有用的工具和tips:</p>
<p><a href="http://www.methodscount.com/" target="_blank" rel="noopener">MethodsCount.com</a> 将会告诉你一个库有多少方法, 还提供了每个方法的依赖.</p>
<p><a href="https://github.com/JakeWharton/dex-method-list" target="_blank" rel="noopener">JakeWharton/dex-method-list utility</a> 可以显示.apk, .aar, .dex, .jar或.class文件中的所有方法引用. 这可以用来发现一个库中到底有多少方法是被你的app使用了.</p>
<p><a href="https://github.com/mihaip/dex-method-counts" target="_blank" rel="noopener">mihaip/dex-method-counts</a> 这个工具可以按包来输出方法, 计算出一个DEX文件中的方法数然后按包来分组输出. 这有利于我们明白哪些库是方法数的主要来源.</p>
<p><a href="https://gradle.org/" target="_blank" rel="noopener">Gradle build system</a> 提供了关于项目结构很有价值的信息. 一个有用的task是<code>dependencies</code>, 让你看到库的依赖树, 这样你就可以看到重复的依赖, 进而删除它们来减少方法数.</p>
<p><a href="http://classyshark.com/" target="_blank" rel="noopener">Classyshark</a> 是一个Android可执行文件的浏览器. 用这个工具你可以打开Android的可执行文件(.jar, .class, .apk, .dex, .so, .aar, 和Android XML)来分析它的内容.</p>
<p><a href="http://inloop.github.io/apk-method-count/" target="_blank" rel="noopener">apk-method-count</a> 这是一个工具, 用来快速地查apk中的方法数, 拖拽apk之后就会得到结果.</p>
<h2 id="What’s-in-the-APK-APK中有什么"><a href="#What’s-in-the-APK-APK中有什么" class="headerlink" title="What’s in the APK APK中有什么"></a><a href="http://crushingcode.co/whats-in-the-apk/" target="_blank" rel="noopener">What’s in the APK</a> APK中有什么</h2><p>APK: Android application package 是Android系统的一种文件格式, 实际上是一种压缩文件, 如果把.apk重命名为.zip, 就可以取出其内容.</p>
<p>但是此时我们直接在文本编辑器打开AndroidManifest.xml的时候看到的全是机器码.</p>
<p>当然是有工具来帮我们分析这些东西的, 这个工具从一开始就有, 那就是aapt, 它是Android Build Tool的一部分.</p>
<p><strong>aapt - Android Asset Packaging Tool</strong> 这个工具可以用来查看和增删apk中的文件, 打包资源, 研究PNG文件等等.</p>
<p>它的位置在: <code>&lt;path_to_android_sdk&gt;/build-tools/&lt;build_tool_version_such_as_24.0.2&gt;/aapt</code>.</p>
<p>aapt能做的事情, 从man可以看出:</p>
<ul>
<li>aapt list - Listing contents of a ZIP, JAR or APK file.</li>
<li>aapt dump - Dumping specific information from an APK file.</li>
<li>aapt package - Packaging Android resources.</li>
<li>aapt remove - Removing files from a ZIP, JAR or APK file.</li>
<li>aapt add - Adding files to a ZIP, JAR or APK file.</li>
<li>aapt crunch - Crunching PNG files.</li>
</ul>
<p>用这个工具来分析我们的apk:</p>
<p>输出基本信息:<br><code>aapt dump badging app-debug.apk</code></p>
<p>输出声明的权限:<br><code>aapt dump permissions app-debug.apk</code></p>
<p>输出配置:<br><code>aapt dump configurations app-debug.apk</code></p>
<p>还有其他这些:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Print the resource table from the APK.</span><br><span class="line">aapt dump resources app-debug.apk</span><br><span class="line"></span><br><span class="line"># Print the compiled xmls in the given assets.</span><br><span class="line">aapt dump xmltree app-debug.apk</span><br><span class="line"></span><br><span class="line"># Print the strings of the given compiled xml assets.</span><br><span class="line">aapt dump xmlstrings app-debug.apk</span><br><span class="line"></span><br><span class="line"># List contents of Zip-compatible archive.</span><br><span class="line">aapt list -v -a  app-debug.apk</span><br></pre></td></tr></table></figure></p>
<h2 id="Reductor-Redux-for-Android"><a href="#Reductor-Redux-for-Android" class="headerlink" title="Reductor - Redux for Android"></a><a href="https://yarikx.github.io/Reductor-prologue/" target="_blank" rel="noopener">Reductor - Redux for Android</a></h2><p>Redux是一个当前JavaScript中很火的构架模式. Reductor把它的概念借鉴到了Java和Android中.</p>
<p>关于状态管理到底有什么好方法呢, 作者想到了前端开发中的SPA(Single-page application), 和Android应用很像, 有没有什么可借鉴的呢? 答案是有.</p>
<p><a href="http://redux.js.org/" target="_blank" rel="noopener">Redux</a> 是一个JavaScript应用的可预测的状态容器, 可以用下面三个基本原则来描述:</p>
<ul>
<li>单一的真相来源</li>
<li>状态只读</li>
<li>变化是纯函数造成的</li>
</ul>
<p>Redux的灵感来源有<a href="http://facebook.github.io/flux/" target="_blank" rel="noopener">Flux</a>和<a href="https://github.com/evancz/elm-architecture-tutorial/" target="_blank" rel="noopener">Elm Architecture</a>.<br>强烈建议阅读一下它的<a href="http://redux.js.org/docs/introduction/Motivation.html" target="_blank" rel="noopener">文档</a>.</p>
<p><a href="https://github.com/Yarikx/reductor" target="_blank" rel="noopener">Reductor</a>是作者用Java又实现了一次Redux.</p>
<p>作者用了一个Todo app的例子来说明如何使用, 以及它的好处.</p>
<p>作者先写了一个naive的实现, 然后不断地举出它的缺点, 然后改进它.</p>
<p>其中作者用到了<a href="https://github.com/hrldcpr/pcollections" target="_blank" rel="noopener">pcollection</a>来实现persistent/immutable的集合.</p>
<p>最后还把代码改为对测试友好的.</p>
<h2 id="Android-leak-pattern-subscriptions-in-views"><a href="#Android-leak-pattern-subscriptions-in-views" class="headerlink" title="Android leak pattern: subscriptions in views"></a><a href="https://medium.com/@pyricau/android-leak-pattern-subscriptions-in-views-18f0860aa74c?swoff=true" target="_blank" rel="noopener">Android leak pattern: subscriptions in views</a></h2><p>开始作者举了一个例子, 一个自定义View, subscribe了Authenticator单例的username变化事件, 从而更新UI.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeaderView</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Authenticator authenticator;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HeaderView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onFinishInflate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> TextView usernameView = (TextView) findViewById(R.id.username);</span><br><span class="line">    authenticator.username().subscribe(<span class="keyword">new</span> Action1&lt;String&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        usernameView.setText(username);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是代码存在一个主要的问题: 我们从来没有unsubscribe. 这样匿名内部类对象就持有外部类对象, 整个view hierarchy就泄露了, 不能被GC.</p>
<p>为了解决这个问题, 在View的<code>onDetachedFromWindow()</code>回调里调用<code>unsubscribe()</code>.</p>
<p>作者以为这样解决了问题, 但是并没有, 还是检测出了泄露, 并且作者发现View的<code>onAttachedToWindow()</code>和<code>onDetachedFromWindow()</code>都没有被调用.</p>
<p>作者研究了<code>onAttachedToWindow()</code>的调用时机:</p>
<ul>
<li>When a view is added to a parent view with a window, onAttachedToWindow() is called immediately, from addView().</li>
<li>When a view is added to a parent view with no window, onAttachedToWindow() will be called when that parent is attached to a window.</li>
</ul>
<p>而作者的布局是在Activity的<code>onCreate()</code>里面<code>setContentView()</code>设置的.<br>这时候每一个View都收到了<code>View.onFinishInflate()</code>回调, 却没有调<code>View.onAttachedToWindow()</code>.</p>
<p><code>View.onAttachedToWindow()</code> is called on the first view traversal, sometime after <code>Activity.onStart()</code>.</p>
<p><code>onStart()</code>方法是不是每次都会调用呢? 不是的, 如果我们在<code>onCreate()</code>里面调用了<code>finish()</code>, <code>onDestroy()</code>会立即执行, 而不经过其中的其他生命周期回调.</p>
<p>明白了这个原理之后, 作者的改进是把订阅放在了<code>View.onAttachedToWindow()</code>里, 这样就不会泄露了. 对称总是好的.</p>
<h2 id="Annotation-Processing-in-Android-Studio-注解和其处理器"><a href="#Annotation-Processing-in-Android-Studio-注解和其处理器" class="headerlink" title="Annotation Processing in Android Studio 注解和其处理器"></a><a href="https://medium.com/@aitorvs/annotation-processing-in-android-studio-7042ccb83024#.khjikdf51" target="_blank" rel="noopener">Annotation Processing in Android Studio</a> 注解和其处理器</h2><p>作者用例子说明了如何自定义注解和其处理器, 让被标记的类自动成为Parcelable的.<br>看了这个有助于理解各种依赖和了解相关的目录结构.</p>
<p>建议使用: <a href="https://bitbucket.org/hvisser/android-apt" target="_blank" rel="noopener">android-apt</a>.</p>
<p><a href="https://developer.android.com/reference/android/os/Parcelable.html" target="_blank" rel="noopener">Parcelable</a>.<br>相关库代码: <a href="https://github.com/aitorvs/auto-parcel" target="_blank" rel="noopener">aitorvs/auto-parcel</a>.</p>
<h2 id="Writing-Better-Adapters-写出更好的Adapter"><a href="#Writing-Better-Adapters-写出更好的Adapter" class="headerlink" title="Writing Better Adapters 写出更好的Adapter"></a><a href="https://medium.com/@dpreussler/writing-better-adapters-1b09758407d2#.ngas0y7j1" target="_blank" rel="noopener">Writing Better Adapters</a> 写出更好的Adapter</h2><p>在Android应用中, 经常需要展示List, 那就需要一个Adapter来持有数据.</p>
<p>RecyclerView的基本操作是: 创建一个view, 然后这个ViewHolder显示view数据; 把这个ViewHolder和adapter持有的数据绑定, 通常是一个model classes的list.</p>
<p>当数据类型只有一种时, 实现很简单, 不容易出错. 但是当要显示的数据有很多种时, 就变得复杂起来.</p>
<p>首先你需要覆写:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">override fun getItemViewType(position: Int) : Int</span><br></pre></td></tr></table></figure></p>
<p>默认是返回0, 实现以后把不同的type转换为不同的整型值.</p>
<p>然后你需要覆写:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): RecyclerView.ViewHolder</span><br></pre></td></tr></table></figure></p>
<p>为每一种type创建一个ViewHolder.</p>
<p>第三步是:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">override fun onBindViewHolder(holder: ViewHolder, position: Int): Any</span><br></pre></td></tr></table></figure></p>
<p>这里没有type参数.</p>
<p><strong>The Uglyness</strong><br>好像看起来没有什么问题?<br>让我们重新看<code>getItemViewType()</code>这个方法. 系统需要给每一个position都对应一个type, 所以你可能会写出这样的代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (things.get(position) is Duck) &#123;</span><br><span class="line">    <span class="keyword">return</span> TYPE_DUCK</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (things.get(position) is Mouse) &#123;</span><br><span class="line">    <span class="keyword">return</span> TYPE_MOUSE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这很丑不是吗?</p>
<p>如果你的ViewHolder没有一个共同的基类, 在binding的时候也是这么丑:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">override fun onBindViewHolder(holder: RecyclerView.ViewHolder, position: Int) &#123;</span><br><span class="line">    val thing = things.get(position)</span><br><span class="line">    if (thing is Animal) &#123;</span><br><span class="line">        (holder as AnimalViewHolder).bind(thing as Animal)</span><br><span class="line">    &#125; else if (thing is Car) &#123;</span><br><span class="line">        (holder as CarViewHolder).bind(thing as Car)</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>很多的instance-of和强制类型转换, 它们都是code smells. 违反了很多软件设计的原则, 并且当我们想要新添一种类型时, 需要改动很多方法. 我们的目标是添加新类型的时候不用更改Adapter之前的代码.<br>开闭原则: Open for Extension, Closed for Modification.</p>
<p><strong>Let’s Fix It</strong><br>用一个map来查询? 不好.<br>把type放在model里? 不好.</p>
<p>解决问题的一种办法是: 加入ViewModel, 作为中间层.</p>
<p>但是如果你不想创建很多的ViewModel类, 还有其他的办法: <a href="https://en.wikipedia.org/wiki/Visitor_pattern" target="_blank" rel="noopener">Visitor模式</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">interface Visitable &#123;</span><br><span class="line">    fun type(typeFactory: TypeFactory) : Int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface Animal : Visitable</span><br><span class="line">interface Car : Visitable</span><br><span class="line"></span><br><span class="line">class Mouse: Animal &#123;</span><br><span class="line">    override fun type(typeFactory: TypeFactory) </span><br><span class="line">        = typeFactory.type(this)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>工厂:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">interface TypeFactory &#123;</span><br><span class="line">    fun type(duck: Duck): Int</span><br><span class="line">    fun type(mouse: Mouse): Int</span><br><span class="line">    fun type(dog: Dog): Int</span><br><span class="line">    fun type(car: Car): Int</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>返回对应的id:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class TypeFactoryForList : TypeFactory &#123;</span><br><span class="line">    override fun type(duck: Duck) = R.layout.duck</span><br><span class="line">    override fun type(mouse: Mouse) = R.layout.mouse</span><br><span class="line">    override fun type(dog: Dog) = R.layout.dog</span><br><span class="line">    override fun type(car: Car) = R.layout.car</span><br></pre></td></tr></table></figure></p>
<h2 id="Material-Intro-Screen-for-Android-Apps"><a href="#Material-Intro-Screen-for-Android-Apps" class="headerlink" title="Material Intro Screen for Android Apps"></a><a href="https://medium.com/tangoagency/material-intro-screen-for-android-apps-c4317fbac923?source=latest" target="_blank" rel="noopener">Material Intro Screen for Android Apps</a></h2><p>现在有两个主流的libraries为Android 应用提供了好看的intro screens, 但是感觉并不是很好用, 所以作者他们发布了一个新的欢迎界面的库<a href="https://github.com/TangoAgency/material-intro-screen/" target="_blank" rel="noopener">TangoAgency/material-intro-screen
</a>, 好用易扩展.</p>
<h2 id="Testing-Legacy-Code-Hidden-Dependencies"><a href="#Testing-Legacy-Code-Hidden-Dependencies" class="headerlink" title="Testing Legacy Code: Hidden Dependencies"></a><a href="https://medium.com/@corneliu/testing-legacy-code-hidden-dependencies-9b8cd617953f" target="_blank" rel="noopener">Testing Legacy Code: Hidden Dependencies</a></h2><p>本文讨论<a href="https://en.wikipedia.org/wiki/God_object" target="_blank" rel="noopener">God Object</a>, <a href="https://sourcemaking.com/antipatterns/the-blob" target="_blank" rel="noopener">Blob</a>, 这种很大的类和方法, 做了很多事情. 如果你想要重构, 先加点测试, 也发现很难, 因为它的依赖太多了, 做了太多事情.</p>
<p>首先, 实例化:<br>加set方法, 让数据库依赖抽离出来, 这样测试的时候可以传一个Fake的进去.</p>
<p>第二, 更多依赖:<br>把UserManger和网络请求等依赖也抽为成员变量, 加上set方法或者构造参数, 这样在测试的时候易于把mock的东西传进去.</p>
<p>第三, 清理: 要牢记<a href="https://en.wikipedia.org/wiki/Single_responsibility_principle" target="_blank" rel="noopener">单一职能原则</a>, 进行职能拆分.</p>
<p>最后, 现实: 清理是一个持续化的过程, 得一步一步来, 有时候小步的改动会帮助你发现另外需要改动的地方. </p>
<h1 id="LIBRARIES-amp-CODE"><a href="#LIBRARIES-amp-CODE" class="headerlink" title="LIBRARIES &amp; CODE"></a>LIBRARIES &amp; CODE</h1><h2 id="EncryptedPreferences"><a href="#EncryptedPreferences" class="headerlink" title="EncryptedPreferences"></a><a href="https://github.com/PDDStudio/EncryptedPreferences" target="_blank" rel="noopener">EncryptedPreferences</a></h2><p>AES-256加密的SharedPreferences.</p>
<h2 id="Pury"><a href="#Pury" class="headerlink" title="Pury"></a><a href="https://github.com/NikitaKozlov/Pury" target="_blank" rel="noopener">Pury</a></h2><p>报告多个不同事件之间的时间, 可用于性能测量.</p>
<h2 id="Floating-Navigation-View"><a href="#Floating-Navigation-View" class="headerlink" title="Floating-Navigation-View"></a><a href="https://github.com/andremion/Floating-Navigation-View" target="_blank" rel="noopener">Floating-Navigation-View</a></h2><p>Floating Action Button, 展开后是一个NavigationView.</p>
<h2 id="Material-Intro-Screen"><a href="#Material-Intro-Screen" class="headerlink" title="Material Intro Screen"></a><a href="https://github.com/TangoAgency/material-intro-screen" target="_blank" rel="noopener">Material Intro Screen</a></h2><p>易用易扩展的欢迎界面.</p>
<h1 id="SPECIALS"><a href="#SPECIALS" class="headerlink" title="SPECIALS"></a>SPECIALS</h1><h2 id="Huge-list-of-useful-resources-for-Android-development"><a href="#Huge-list-of-useful-resources-for-Android-development" class="headerlink" title="Huge list of useful resources for Android development"></a><a href="http://www.anysoftwaretools.com/best-android-development-resources/" target="_blank" rel="noopener">Huge list of useful resources for Android development</a></h2><p>资源分享, 包括博客论坛Video社区等等.</p>

    </div>

    
    
    
        

  <div class="followme">
    <p>Welcome to my other publishing channels</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/uploads/qrcode_for_gh_0e2ed690dcda_258.jpg">
            <span class="icon">
              <i class="圣骑士Wind"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/Android-Weekly/" rel="tag"># Android Weekly</a>
              <a href="/tags/Wear/" rel="tag"># Wear</a>
              <a href="/tags/Memory-Leak/" rel="tag"># Memory Leak</a>
              <a href="/tags/Annotation/" rel="tag"># Annotation</a>
              <a href="/tags/pre-launch/" rel="tag"># pre-launch</a>
              <a href="/tags/Handler/" rel="tag"># Handler</a>
              <a href="/tags/RxAndroid/" rel="tag"># RxAndroid</a>
              <a href="/tags/Profile/" rel="tag"># Profile</a>
              <a href="/tags/Methods-Count/" rel="tag"># Methods Count</a>
              <a href="/tags/APK/" rel="tag"># APK</a>
              <a href="/tags/Redux/" rel="tag"># Redux</a>
              <a href="/tags/Reductor/" rel="tag"># Reductor</a>
              <a href="/tags/Adapter/" rel="tag"># Adapter</a>
              <a href="/tags/Intro-Screen/" rel="tag"># Intro Screen</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/Android/Android-Weekly/2016/09/22/android-weekly-notes-issue-223/" rel="prev" title="Android Weekly Notes Issue 223">
      <i class="fa fa-chevron-left"></i> Android Weekly Notes Issue 223
    </a></div>
      <div class="post-nav-item">
    <a href="/Android/Android-Weekly/2016/10/09/android-weekly-notes-issue-225/" rel="next" title="Android Weekly Notes Issue 225">
      Android Weekly Notes Issue 225 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Android-Weekly-Issue-224"><span class="nav-number">1.</span> <span class="nav-text">Android Weekly Issue #224</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ARTICLES-amp-TUTORIALS"><span class="nav-number">2.</span> <span class="nav-text">ARTICLES &amp; TUTORIALS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Apk%E7%9A%84pre-launch%E6%8A%A5%E5%91%8A-Awesome-pre-launch-reports-for-Alpha-Beta-APK%E2%80%99s"><span class="nav-number">2.1.</span> <span class="nav-text">Apk的pre-launch报告 Awesome pre-launch reports for Alpha&#x2F;Beta APK’s</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Wear-Complications-API"><span class="nav-number">2.2.</span> <span class="nav-text">Wear Complications API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-Handler-Internals"><span class="nav-number">2.3.</span> <span class="nav-text">Android Handler Internals</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Crunching-RxAndroid-Part-10-%E7%BB%86%E7%BB%86%E5%92%80%E5%9A%BCRxAndroid"><span class="nav-number">2.4.</span> <span class="nav-text">Crunching RxAndroid - Part 10  细细咀嚼RxAndroid</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pury-a-new-way-to-profile-your-Android-application"><span class="nav-number">2.5.</span> <span class="nav-text">Pury a new way to profile your Android application</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E6%96%B9%E6%B3%95%E6%95%B0%E9%99%90%E5%88%B6%E9%97%AE%E9%A2%98-Dealing-With-the-65K-Methods-limit-on-Android"><span class="nav-number">2.6.</span> <span class="nav-text">处理方法数限制问题 Dealing With the 65K Methods limit on Android</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#What%E2%80%99s-in-the-APK-APK%E4%B8%AD%E6%9C%89%E4%BB%80%E4%B9%88"><span class="nav-number">2.7.</span> <span class="nav-text">What’s in the APK APK中有什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reductor-Redux-for-Android"><span class="nav-number">2.8.</span> <span class="nav-text">Reductor - Redux for Android</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-leak-pattern-subscriptions-in-views"><span class="nav-number">2.9.</span> <span class="nav-text">Android leak pattern: subscriptions in views</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Annotation-Processing-in-Android-Studio-%E6%B3%A8%E8%A7%A3%E5%92%8C%E5%85%B6%E5%A4%84%E7%90%86%E5%99%A8"><span class="nav-number">2.10.</span> <span class="nav-text">Annotation Processing in Android Studio 注解和其处理器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Writing-Better-Adapters-%E5%86%99%E5%87%BA%E6%9B%B4%E5%A5%BD%E7%9A%84Adapter"><span class="nav-number">2.11.</span> <span class="nav-text">Writing Better Adapters 写出更好的Adapter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Material-Intro-Screen-for-Android-Apps"><span class="nav-number">2.12.</span> <span class="nav-text">Material Intro Screen for Android Apps</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Testing-Legacy-Code-Hidden-Dependencies"><span class="nav-number">2.13.</span> <span class="nav-text">Testing Legacy Code: Hidden Dependencies</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LIBRARIES-amp-CODE"><span class="nav-number">3.</span> <span class="nav-text">LIBRARIES &amp; CODE</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#EncryptedPreferences"><span class="nav-number">3.1.</span> <span class="nav-text">EncryptedPreferences</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pury"><span class="nav-number">3.2.</span> <span class="nav-text">Pury</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Floating-Navigation-View"><span class="nav-number">3.3.</span> <span class="nav-text">Floating-Navigation-View</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Material-Intro-Screen"><span class="nav-number">3.4.</span> <span class="nav-text">Material Intro Screen</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SPECIALS"><span class="nav-number">4.</span> <span class="nav-text">SPECIALS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Huge-list-of-useful-resources-for-Android-development"><span class="nav-number">4.1.</span> <span class="nav-text">Huge list of useful resources for Android development</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Dandan Meng"
      src="/uploads/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Dandan Meng</p>
  <div class="site-description" itemprop="description">This is a technical blog site of an Android developer.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">84</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">314</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/mengdd" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;mengdd" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://www.cnblogs.com/mengdd/" title="http:&#x2F;&#x2F;www.cnblogs.com&#x2F;mengdd&#x2F;" rel="noopener" target="_blank">圣骑士Wind@博客园</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.jianshu.com/u/c4192d22f989" title="http:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;c4192d22f989" rel="noopener" target="_blank">圣骑士Wind@简书</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://juejin.im/user/57ca63748ac247006446cf26" title="https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;57ca63748ac247006446cf26" rel="noopener" target="_blank">圣骑士Wind@掘金</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dandan Meng</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"6NRSbfxTnKEHn4YEM8Gf4HdP-gzGzoHsz","app_key":"h6jBdqdDSdfOuICNkOVq2DQ0","server_url":null,"security":true};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://dandanmeng.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "http://mengdd.github.io/Android/Android-Weekly/2016/10/02/android-weekly-notes-issue-224/";
    this.page.identifier = "Android/Android-Weekly/2016/10/02/android-weekly-notes-issue-224/";
    this.page.title = "Android Weekly Notes Issue 224";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://dandanmeng.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
